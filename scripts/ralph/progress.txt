# Ralph Progress Log
Started: 2026-01-26
Feature: Receipt OCR Feature
Parent Task: 1

## Codebase Patterns
(Patterns discovered during this feature build)

---

## 2026-01-26 - Add status field to expenses table
Thread: https://ampcode.com/threads/T-019bfa99-5eab-7233-b180-cc878c77b38e
Task ID: 2
- Added migration to add 'status' column (TEXT, default 'confirmed')
- Added ExpenseStatusDraft and ExpenseStatusConfirmed constants in models
- Added Status field to Expense model
- Updated Create() to default status to 'confirmed' if not specified
- Updated GetByID() to include status field
- Updated GetByUserID() to filter by status='confirmed'
- Updated GetByUserIDAndDateRange() to filter by status='confirmed'
- Updated Update() to include status field
- Updated GetTotalByUserIDAndDateRange() to only sum confirmed expenses
- Updated scanExpenses() helper to include status field
- **Learnings for future iterations:**
  - When adding columns, use ALTER TABLE ADD COLUMN IF NOT EXISTS for idempotent migrations
  - List queries should filter by status='confirmed' to exclude drafts from user-facing views
  - Create() defaults status to confirmed for backward compatibility
---

## 2026-01-26 - Add Gemini API config and client
Thread: https://ampcode.com/threads/T-019bfa9b-a8e2-7521-a455-3b183111f0fa
Task ID: 3
- Added GeminiAPIKey field to Config struct in internal/config/config.go
- Added GEMINI_API_KEY to .env.example with documentation
- Created internal/gemini/client.go with Client wrapper
- Uses google.golang.org/genai SDK (v1.43.0) with BackendGeminiAPI
- Model constant: gemini-2.5-flash-preview-05-20
- NewClient validates API key and wraps genai.Client
- **Learnings for future iterations:**
  - Use genai.BackendGeminiAPI for Gemini Developer API (not Vertex AI)
  - API key env var is GEMINI_API_KEY (SDK also supports GOOGLE_API_KEY)
  - SDK uses google.golang.org/genai not the deprecated google.golang.org/generative-ai
---

## 2026-01-26 - Create receipt parser service
Thread: https://ampcode.com/threads/T-019bfa9d-7bdc-7609-a175-63936eeca1ed
Task ID: 4
- Created internal/gemini/receipt_parser.go with ParseReceipt function
- Defined ReceiptData struct: Amount (decimal.Decimal), Merchant (string), Date (time.Time), SuggestedCategory (string), Confidence (float64)
- DefaultCategories list matches database SeedCategories for consistent category suggestions
- Prompt instructs Gemini to return JSON with amount, merchant, date, suggested_category, confidence fields
- parseReceiptResponse handles markdown code block wrappers (```json...```)
- Handles partial extraction gracefully (empty strings, zero values)
- Added comprehensive unit tests for parseReceiptResponse covering edge cases
- **Learnings for future iterations:**
  - Gemini may wrap JSON in markdown code blocks - strip ```json and ``` before parsing
  - Use genai.Blob with InlineData for image bytes, not file uploads
  - Include example JSON in prompt for better structured output
  - Keep DefaultCategories in sync with database SeedCategories
---

## 2026-01-26 - Add photo message handler
Thread: https://ampcode.com/threads/T-019bfa9f-89c7-765a-a1ee-25f186f09800
Task ID: 5
- Added geminiClient field to Bot struct in internal/bot/bot.go
- Gemini client is initialized in New() if GEMINI_API_KEY is configured
- Modified defaultHandler to detect photo messages and route to handlePhoto
- Added downloadPhoto helper function using bot.GetFile and bot.FileDownloadLink
- Added handlePhoto handler in internal/bot/handlers.go:
  - Gets largest photo size (last in Photo array)
  - Downloads photo from Telegram servers
  - Passes image bytes to gemini.ParseReceipt
  - Creates expense with status=draft and extracted data
  - Returns confirmation with amount, merchant, category, and confidence
- Added categoryUncategorized constant to fix goconst lint warning
- **Learnings for future iterations:**
  - Telegram provides multiple photo sizes, use update.Message.Photo[len-1] for largest
  - Use bot.GetFile(ctx, &GetFileParams{FileID}) then bot.FileDownloadLink(file) to download
  - Must use http.NewRequestWithContext for proper cancellation support
  - Defer resp.Body.Close() needs explicit error discard: defer func() { _ = resp.Body.Close() }()
  - Receipt OCR creates draft expenses (status=draft) for user confirmation
---

## 2026-01-26 - Create draft expense from receipt
Thread: https://ampcode.com/threads/T-019bfaa3-3406-7519-aedd-2b68dc6757a8
Task ID: 6
- Extended handlePhoto to store receipt_file_id in the expense (largestPhoto.FileID)
- Added inline keyboard with Confirm/Edit/Cancel buttons using models.InlineKeyboardMarkup
- Buttons use CallbackData format: receipt_confirm_ID, receipt_edit_ID, receipt_cancel_ID
- Updated message format to show date from receipt parsing
- Message now returns *models.Message with ID for future message editing
- Added logging of message_id after successful send
- **Learnings for future iterations:**
  - InlineKeyboardMarkup uses nested [][]InlineKeyboardButton for rows of buttons
  - CallbackData is the string sent back when user clicks the button
  - SendMessage returns *models.Message which has ID field for message_id tracking
  - Date formatting: use "02 Jan 2006" for human-readable format
---

## 2026-01-26 - Handle callback queries for confirmation
Thread: https://ampcode.com/threads/T-019bfaa5-1059-7542-bf4f-951af59b5688
Task ID: 8
- Registered callback query handlers in bot.go using HandlerTypeCallbackQueryData
- Added handleReceiptCallback for receipt_confirm, receipt_cancel, receipt_edit, receipt_back
- handleConfirmReceipt: updates expense status to 'confirmed' and edits message
- handleCancelReceipt: deletes draft expense and edits message with cancellation
- handleEditReceipt: shows sub-menu with Edit Amount / Edit Category buttons
- handleBackToReceipt: returns to main confirmation view with Confirm/Edit/Cancel buttons
- Added handleEditCallback for edit_amount and edit_category actions
- showCategorySelection: displays inline keyboard with all categories (2 per row)
- handleSetCategoryCallback: updates expense category and returns to confirmation view
- All handlers use bot.AnswerCallbackQuery to acknowledge button press (removes spinner)
- All handlers use bot.EditMessageText to update existing messages
- **Learnings for future iterations:**
  - Use bot.HandlerTypeCallbackQueryData for callback query handlers
  - Pattern "receipt_" with MatchTypePrefix catches all receipt_confirm, receipt_cancel, etc.
  - update.CallbackQuery.Message.Message.Chat.ID for chat ID (nested Message field)
  - update.CallbackQuery.Message.Message.ID for message ID to edit
  - Always call AnswerCallbackQuery first to remove loading spinner
  - Use EditMessageText with ReplyMarkup to update both text and inline keyboard
  - Parse callback data format "action_subaction_id" with strings.Split
---

## 2026-01-26 - Edit amount flow
Thread: https://ampcode.com/threads/T-019bfaa8-aaea-715b-ace6-e2d484aa3dff
Task ID: 9
- Added pendingEdit struct to track pending edit operations (ExpenseID, EditType, MessageID)
- Added pendingEdits map and pendingEditsMu mutex to Bot struct for concurrent access
- Added promptEditAmount: prompts user to enter new amount, stores pending edit state
- Added handlePendingEdit: checks for pending edits in defaultHandler before expense parsing
- Added processAmountEdit: parses user input, updates expense, shows updated confirmation
- Added handleCancelEditCallback: clears pending state and returns to edit menu
- Registered cancel_edit_ callback handler in bot.go
- Added parseAmount helper function in parser.go for amount parsing with validation
- **Learnings for future iterations:**
  - Use map[chatID]*pendingEdit for storing pending edit state per chat
  - Use sync.RWMutex for concurrent map access (RLock for reads, Lock for writes)
  - Check pending edit state before processing free-text expense input in defaultHandler
  - Store MessageID in pending state to edit the original message after update
  - parseAmount strips $ prefix and handles comma decimal separators
---

## 2026-01-26 - Category matching logic
Thread: https://ampcode.com/threads/T-019bfaac-93aa-7010-bf41-5e6b63aff8c9
Task ID: 7
- Created internal/bot/category_matcher.go with MatchCategory function
- Matching strategy: exact (case-insensitive) -> contains -> reverse contains -> word-based
- extractSignificantWords splits on -, /, & and filters stop words and short words
- isStopWord filters common words (and, the, for) from matching
- Returns *models.Category pointer or nil if no match found
- Added comprehensive unit tests in category_matcher_test.go
- **Learnings for future iterations:**
  - For contains matching, prefer shorter category names (more specific match)
  - For reverse contains (suggested contains category name), prefer longer matches
  - Word-based matching useful for partial matches like "travel" -> "Travel & Vacation"
  - Filter words under 3 chars and stop words to avoid false positives
---
