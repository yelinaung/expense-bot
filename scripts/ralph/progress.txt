# Ralph Progress Log
Started: 2026-01-27
Feature: Improve Test Coverage to 80%
Parent Task: 15

## Codebase Patterns
- Use t.Helper() in test setup functions
- Use testify/require for assertions
- Database tests use database.TestDB(t) which skips if TEST_DATABASE_URL not set
- Integration tests skip with t.Skip() when env vars not set
- Use t.Parallel() for unit tests, avoid for database tests
- Run tests with -p 1 to avoid database race conditions

---

## 2026-01-27 - Parser unit tests
Thread: https://ampcode.com/threads/T-019bfde8-b41a-70fd-94f2-6fe71497296d
Task ID: 16
- Added comprehensive tests for parseAmount function (100% coverage)
- Added tests for extractDescription function (100% coverage)
- Improved ParseAddCommand coverage to 100% with edge cases for bot mentions
- Added edge case tests for ParseExpenseInput (93.8% coverage - remaining uncovered line is unreachable via regex)
- Added edge case tests for ParseAddCommandWithCategories and ParseExpenseInputWithCategories
- Files changed: internal/bot/parser_test.go
- **Learnings for future iterations:**
  - Regex validation before decimal parsing makes some error branches unreachable
  - Table-driven tests with t.Parallel() work well for pure functions
  - Test edge cases like nil/empty slices, whitespace-only inputs, and bot mention formats
---

## 2026-01-27 - Config unit tests
Thread: https://ampcode.com/threads/T-019bfdea-e164-76dc-bb19-ad8ecaab5069
Task ID: 17
- Added test for empty entries from trailing/consecutive commas (covers line 36 continue branch)
- Added test for GeminiAPIKey loading
- Config package now has 100% test coverage
- Files changed: internal/config/config_test.go
- **Learnings for future iterations:**
  - Use t.Setenv() for env var tests, no t.Parallel() needed for subtests
  - Trailing commas/consecutive delimiters create empty strings after split
---

## 2026-01-27 - Repository edge case tests
Thread: https://ampcode.com/threads/T-019bfdec-5e1e-7649-9f1a-20ced70cfb39
Task ID: 18
- Added expense repository tests:
  - TestExpenseRepository_GetTotalByUserIDAndDateRange_MixedStatuses (only counts confirmed)
  - TestExpenseRepository_UpdateNonExistent (no error for non-existent ID)
  - TestExpenseRepository_DeleteNonExistent (no error for non-existent ID)
  - TestExpenseRepository_GetByUserIDAndDateRange_EdgeBoundaries (boundary inclusion/exclusion)
  - TestExpenseRepository_GetByUserID_OnlyConfirmed (filters draft expenses)
  - TestExpenseRepository_GetByUserIDAndDateRange_OnlyConfirmed (filters draft expenses)
  - TestExpenseRepository_Create_DefaultStatus (defaults to confirmed)
  - TestExpenseRepository_Pool (tests Pool() accessor)
- Added category repository tests:
  - TestCategoryRepository_GetByID_NonExistent
  - TestCategoryRepository_GetByName_NonExistent
  - TestCategoryRepository_UpdateNonExistent
  - TestCategoryRepository_DeleteNonExistent
  - TestCategoryRepository_GetAll_Empty
  - TestCategoryRepository_CreateDuplicate
- Added user repository tests:
  - TestUserRepository_UpsertUser_WithEmptyFields
  - TestUserRepository_UpsertUser_UpdateToEmpty
- Files changed: internal/repository/*_test.go
- Repository coverage: expense_repository 83-100%, category_repository 75-100%, user_repository 75-100%
- **Learnings for future iterations:**
  - PostgreSQL Update/Delete with non-existent IDs succeed without error (0 rows affected)
  - Date range queries use >= start and < end (half-open interval)
  - Status filtering in queries is important for business logic tests
---
