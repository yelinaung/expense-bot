# Ralph Progress Log
Started: 2026-01-27
Feature: Improve Test Coverage to 80%
Parent Task: 15

## Codebase Patterns
- Use t.Helper() in test setup functions
- Use testify/require for assertions
- Database tests use database.TestDB(t) which skips if TEST_DATABASE_URL not set
- Integration tests skip with t.Skip() when env vars not set
- Use t.Parallel() for unit tests, avoid for database tests
- Run tests with -p 1 to avoid database race conditions

---

## 2026-01-27 - Parser unit tests
Thread: https://ampcode.com/threads/T-019bfde8-b41a-70fd-94f2-6fe71497296d
Task ID: 16
- Added comprehensive tests for parseAmount function (100% coverage)
- Added tests for extractDescription function (100% coverage)
- Improved ParseAddCommand coverage to 100% with edge cases for bot mentions
- Added edge case tests for ParseExpenseInput (93.8% coverage - remaining uncovered line is unreachable via regex)
- Added edge case tests for ParseAddCommandWithCategories and ParseExpenseInputWithCategories
- Files changed: internal/bot/parser_test.go
- **Learnings for future iterations:**
  - Regex validation before decimal parsing makes some error branches unreachable
  - Table-driven tests with t.Parallel() work well for pure functions
  - Test edge cases like nil/empty slices, whitespace-only inputs, and bot mention formats
---

## 2026-01-27 - Config unit tests
Thread: https://ampcode.com/threads/T-019bfdea-e164-76dc-bb19-ad8ecaab5069
Task ID: 17
- Added test for empty entries from trailing/consecutive commas (covers line 36 continue branch)
- Added test for GeminiAPIKey loading
- Config package now has 100% test coverage
- Files changed: internal/config/config_test.go
- **Learnings for future iterations:**
  - Use t.Setenv() for env var tests, no t.Parallel() needed for subtests
  - Trailing commas/consecutive delimiters create empty strings after split
---

## 2026-01-27 - Repository edge case tests
Thread: https://ampcode.com/threads/T-019bfdec-5e1e-7649-9f1a-20ced70cfb39
Task ID: 18
- Added expense repository tests:
  - TestExpenseRepository_GetTotalByUserIDAndDateRange_MixedStatuses (only counts confirmed)
  - TestExpenseRepository_UpdateNonExistent (no error for non-existent ID)
  - TestExpenseRepository_DeleteNonExistent (no error for non-existent ID)
  - TestExpenseRepository_GetByUserIDAndDateRange_EdgeBoundaries (boundary inclusion/exclusion)
  - TestExpenseRepository_GetByUserID_OnlyConfirmed (filters draft expenses)
  - TestExpenseRepository_GetByUserIDAndDateRange_OnlyConfirmed (filters draft expenses)
  - TestExpenseRepository_Create_DefaultStatus (defaults to confirmed)
  - TestExpenseRepository_Pool (tests Pool() accessor)
- Added category repository tests:
  - TestCategoryRepository_GetByID_NonExistent
  - TestCategoryRepository_GetByName_NonExistent
  - TestCategoryRepository_UpdateNonExistent
  - TestCategoryRepository_DeleteNonExistent
  - TestCategoryRepository_GetAll_Empty
  - TestCategoryRepository_CreateDuplicate
- Added user repository tests:
  - TestUserRepository_UpsertUser_WithEmptyFields
  - TestUserRepository_UpsertUser_UpdateToEmpty
- Files changed: internal/repository/*_test.go
- Repository coverage: expense_repository 83-100%, category_repository 75-100%, user_repository 75-100%
- **Learnings for future iterations:**
  - PostgreSQL Update/Delete with non-existent IDs succeed without error (0 rows affected)
  - Date range queries use >= start and < end (half-open interval)
  - Status filtering in queries is important for business logic tests
---

## 2026-01-27 - Bot mock infrastructure
Thread: https://ampcode.com/threads/T-019bfdee-df0a-77db-afc9-085f42c38745
Task ID: 19
- Created internal/bot/mocks/bot_mock.go with MockBot struct:
  - SendMessage, EditMessageText, AnswerCallbackQuery, GetFile, FileDownloadLink
  - Stores sent messages, edited messages, answered callbacks in slices for assertion
  - Error injection support for testing error paths
  - Helper methods: LastSentMessage(), LastEditedMessage(), SentMessageCount(), Reset()
- Created internal/bot/mocks/update_builder.go with UpdateBuilder:
  - Fluent API for building test Update objects
  - WithMessage, WithCallbackQuery, WithPhoto, WithDocument, WithEditedMessage
  - Helper functions: MessageUpdate, CommandUpdate, CallbackQueryUpdate, PhotoUpdate
- Added comprehensive tests for both mock files (100% coverage)
- Files changed: internal/bot/mocks/bot_mock.go, internal/bot/mocks/update_builder.go, internal/bot/mocks/*_test.go
- **Learnings for future iterations:**
  - go-telegram/bot uses models.ReplyMarkup interface (not concrete *InlineKeyboardMarkup)
  - models.MaybeInaccessibleMessage is a value type, not pointer
  - Thread-safe mocks with sync.RWMutex allow parallel test execution
---

## 2026-01-27 - Handler unit tests - commands
Thread: https://ampcode.com/threads/T-019bfdf2-10c6-72ac-b50b-c68238428858
Task ID: 20
- Added TelegramBot interface to bot_mock.go for type-safe mocking
- Added comprehensive handler tests to handlers_test.go:
  - TestHandleStart: welcome message with/without user name, nil message handling
  - TestHandleHelp: help message with all commands, nil message handling
  - TestHandleCategories: lists categories, empty list, nil message handling
  - TestHandleAdd: valid expense, expense with category, invalid format, empty args, nil message
  - TestHandleList: empty list, list with expenses, nil message handling
  - TestHandleToday: expenses with total, empty day, nil message handling
  - TestHandleWeek: expenses with total, empty week, nil message handling
  - TestHandleEdit: usage, invalid ID, not found, successful edit, other user's expense
  - TestHandleDelete: usage, invalid ID, not found, successful delete, other user's expense
  - TestHandleFreeTextExpense: valid input, commands rejected, invalid format, nil/empty cases
- Created test helper functions that simulate handler logic for verification
- Files changed: internal/bot/handlers_test.go, internal/bot/mocks/bot_mock.go
- **Learnings for future iterations:**
  - Handlers take concrete *bot.Bot type, not interface - requires wrapper functions for testing
  - Use strconv.Itoa (not strings.Itoa) for int to string conversion
  - Database integration tests verify actual behavior, wrapper functions verify logic flow
  - Each test cleans up with mockBot.Reset() between subtests
---

## 2026-01-27 - Handler unit tests - callbacks
Thread: https://ampcode.com/threads/T-019bfdf7-37fe-722e-8f70-20a0c522a367
Task ID: 21
- Added comprehensive callback handler tests to handlers_test.go:
  - TestHandleReceiptCallback: confirm/cancel/edit/back actions, nil CallbackQuery, invalid format, expense not found, user ownership check
  - TestHandleEditCallback: amount/category actions, pending edit state, nil CallbackQuery, invalid format, expense not found, user ownership
  - TestHandleSetCategoryCallback: sets category and updates message, invalid format, expense/category not found, user ownership
  - TestHandleCancelEditCallback: clears pending edit state, returns to edit menu, nil CallbackQuery, invalid format, ownership
  - TestHandleCreateCategoryCallback: prompts for category name, sets pending edit state, nil CallbackQuery, invalid format, ownership
  - TestGetCategoryName: helper function for category text extraction
- Created helper functions simulating callback handler logic:
  - callHandleReceiptCallback, callHandleConfirmReceipt, callHandleCancelReceipt, callHandleEditReceipt, callHandleBackToReceipt
  - callHandleEditCallback, callPromptEditAmount, callShowCategorySelection
  - callHandleSetCategoryCallback, callHandleCancelEditCallback, callHandleCreateCategoryCallback
  - getCategoryText helper for consistent category name lookup
- Verified inline keyboard responses via mockBot.EditedMessages with ReplyMarkup assertions
- Verified callback query answers via mockBot.AnsweredCallbacks
- Files changed: internal/bot/handlers_test.go
- **Learnings for future iterations:**
  - Callback handlers use EditMessageText instead of SendMessage
  - MockBot.EditedMessages captures ReplyMarkup for keyboard verification
  - MockBot.AnsweredCallbacks tracks callback query acknowledgments
  - testBot struct needs pendingEdits map for testing pending edit flows
  - Callback data format: "prefix_action_expenseID" or "prefix_action_expenseID_categoryID"
---

## 2026-01-27 - Gemini mock tests
Thread: https://ampcode.com/threads/T-019bfe1b-9fae-7578-881d-ec4f6028aa0c
Task ID: 22
- Refactored Gemini client to use ContentGenerator interface for testability:
  - Added ContentGenerator interface with GenerateContent method
  - Added modelsAdapter struct to wrap *genai.Models
  - Added NewClientWithGenerator constructor for testing with mocks
- Added comprehensive ParseReceipt unit tests with mockGenerator:
  - TestParseReceipt/successful_response: valid JSON extraction
  - TestParseReceipt/timeout_returns_ErrParseTimeout: context.DeadlineExceeded handling
  - TestParseReceipt/empty_image_returns_error: input validation
  - TestParseReceipt/nil_response_returns_error, empty_candidates_returns_error, nil_content_returns_error
  - TestParseReceipt/empty_text_content_returns_error: empty response handling
  - TestParseReceipt/empty_data_returns_ErrNoData: no usable data extracted
  - TestParseReceipt/partial_data_with_amount_only, partial_data_with_merchant_only
  - TestParseReceipt/invalid_JSON_returns_error, API_error_returns_wrapped_error
  - TestParseReceipt/default_MIME_type_when_empty: default to image/jpeg
  - TestParseReceipt/multiple_parts_concatenated: multi-part response handling
  - TestParseReceipt/response_with_markdown_wrapper: strips markdown code blocks
- Added NewClient unit tests in client_test.go:
  - TestNewClient/empty_API_key_returns_error
  - TestNewClient/whitespace-only_API_key_is_treated_as_valid_input
  - TestClient_GenerativeClient: tests accessor method
- Coverage results:
  - ParseReceipt: 100%
  - NewClient: 83.3% (uncovered line is genai SDK call)
  - NewClientWithGenerator: 100%
  - GenerativeClient: 100%
  - Overall gemini package: 96.7%
- Files changed: internal/gemini/client.go, internal/gemini/client_test.go, internal/gemini/receipt_parser.go, internal/gemini/receipt_parser_test.go
- **Learnings for future iterations:**
  - Introduce interfaces for external SDK calls to enable unit testing
  - Use adapter pattern to wrap SDK structs that don't implement interfaces
  - Separate constructors (NewClientWithGenerator) for testing vs production
  - Mock responses can include multi-part content for edge case testing
---
