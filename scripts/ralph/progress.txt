# Ralph Progress Log
Started: 2026-01-26
Feature: Receipt OCR Feature
Parent Task: 1

## Codebase Patterns
(Patterns discovered during this feature build)

---

## 2026-01-26 - Add status field to expenses table
Thread: https://ampcode.com/threads/T-019bfa99-5eab-7233-b180-cc878c77b38e
Task ID: 2
- Added migration to add 'status' column (TEXT, default 'confirmed')
- Added ExpenseStatusDraft and ExpenseStatusConfirmed constants in models
- Added Status field to Expense model
- Updated Create() to default status to 'confirmed' if not specified
- Updated GetByID() to include status field
- Updated GetByUserID() to filter by status='confirmed'
- Updated GetByUserIDAndDateRange() to filter by status='confirmed'
- Updated Update() to include status field
- Updated GetTotalByUserIDAndDateRange() to only sum confirmed expenses
- Updated scanExpenses() helper to include status field
- **Learnings for future iterations:**
  - When adding columns, use ALTER TABLE ADD COLUMN IF NOT EXISTS for idempotent migrations
  - List queries should filter by status='confirmed' to exclude drafts from user-facing views
  - Create() defaults status to confirmed for backward compatibility
---

## 2026-01-26 - Add Gemini API config and client
Thread: https://ampcode.com/threads/T-019bfa9b-a8e2-7521-a455-3b183111f0fa
Task ID: 3
- Added GeminiAPIKey field to Config struct in internal/config/config.go
- Added GEMINI_API_KEY to .env.example with documentation
- Created internal/gemini/client.go with Client wrapper
- Uses google.golang.org/genai SDK (v1.43.0) with BackendGeminiAPI
- Model constant: gemini-2.5-flash-preview-05-20
- NewClient validates API key and wraps genai.Client
- **Learnings for future iterations:**
  - Use genai.BackendGeminiAPI for Gemini Developer API (not Vertex AI)
  - API key env var is GEMINI_API_KEY (SDK also supports GOOGLE_API_KEY)
  - SDK uses google.golang.org/genai not the deprecated google.golang.org/generative-ai
---

## 2026-01-26 - Create receipt parser service
Thread: https://ampcode.com/threads/T-019bfa9d-7bdc-7609-a175-63936eeca1ed
Task ID: 4
- Created internal/gemini/receipt_parser.go with ParseReceipt function
- Defined ReceiptData struct: Amount (decimal.Decimal), Merchant (string), Date (time.Time), SuggestedCategory (string), Confidence (float64)
- DefaultCategories list matches database SeedCategories for consistent category suggestions
- Prompt instructs Gemini to return JSON with amount, merchant, date, suggested_category, confidence fields
- parseReceiptResponse handles markdown code block wrappers (```json...```)
- Handles partial extraction gracefully (empty strings, zero values)
- Added comprehensive unit tests for parseReceiptResponse covering edge cases
- **Learnings for future iterations:**
  - Gemini may wrap JSON in markdown code blocks - strip ```json and ``` before parsing
  - Use genai.Blob with InlineData for image bytes, not file uploads
  - Include example JSON in prompt for better structured output
  - Keep DefaultCategories in sync with database SeedCategories
---

## 2026-01-26 - Add photo message handler
Thread: https://ampcode.com/threads/T-019bfa9f-89c7-765a-a1ee-25f186f09800
Task ID: 5
- Added geminiClient field to Bot struct in internal/bot/bot.go
- Gemini client is initialized in New() if GEMINI_API_KEY is configured
- Modified defaultHandler to detect photo messages and route to handlePhoto
- Added downloadPhoto helper function using bot.GetFile and bot.FileDownloadLink
- Added handlePhoto handler in internal/bot/handlers.go:
  - Gets largest photo size (last in Photo array)
  - Downloads photo from Telegram servers
  - Passes image bytes to gemini.ParseReceipt
  - Creates expense with status=draft and extracted data
  - Returns confirmation with amount, merchant, category, and confidence
- Added categoryUncategorized constant to fix goconst lint warning
- **Learnings for future iterations:**
  - Telegram provides multiple photo sizes, use update.Message.Photo[len-1] for largest
  - Use bot.GetFile(ctx, &GetFileParams{FileID}) then bot.FileDownloadLink(file) to download
  - Must use http.NewRequestWithContext for proper cancellation support
  - Defer resp.Body.Close() needs explicit error discard: defer func() { _ = resp.Body.Close() }()
  - Receipt OCR creates draft expenses (status=draft) for user confirmation
---
