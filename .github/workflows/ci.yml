name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  GO_VERSION: "1.25.7"

jobs:
  # === SECURITY STAGE ===
  secret-detection:
    name: Secret Detection
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified --trust-local-git-config

  sast:
    name: SAST (Semgrep)
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v6

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto

  # === QUALITY STAGE ===
  lint:
    name: Lint
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.8
        env:
          GOTOOLCHAIN: auto

  fmt-check:
    name: Format Check
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install gofumpt
        run: go install mvdan.cc/gofumpt@latest

      - name: Check formatting
        run: |
          make fmt
          if [ -n "$(git diff --name-only)" ]; then
            echo "Files not formatted with gofumpt:"
            git diff --name-only
            exit 1
          fi

  # === TEST STAGE ===
  test:
    name: Test
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    needs: [secret-detection, lint, sast]
    env:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD || 'test' }}
      POSTGRES_DB: expense_bot_test
      POSTGRES_PORT: 5432
    steps:
      - uses: actions/checkout@v6

      - name: Start PostgreSQL
        run: |
          docker rm -f test-postgres 2>/dev/null || true
          docker run -d --name test-postgres \
            --network container:$(hostname) \
            -e POSTGRES_USER=${{ env.POSTGRES_USER }} \
            -e POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }} \
            -e POSTGRES_DB=${{ env.POSTGRES_DB }} \
            postgres:18-alpine
          echo "Waiting for PostgreSQL..."
          for i in $(seq 1 30); do
            if docker exec test-postgres pg_isready -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} > /dev/null 2>&1; then
              echo "PostgreSQL is ready"
              break
            fi
            sleep 1
          done

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run tests with coverage
        env:
          TEST_DATABASE_URL: postgres://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:${{ env.POSTGRES_PORT }}/${{ env.POSTGRES_DB }}?sslmode=disable
        run: make test-coverage

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          THRESHOLD=50
          echo "Coverage: ${COVERAGE}% (threshold: ${THRESHOLD}%)"
          if [ "$(awk "BEGIN {print ($COVERAGE < $THRESHOLD)}")" = "1" ]; then
            echo "Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%!"
            exit 1
          fi
          echo "Coverage check passed!"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.out
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Stop PostgreSQL
        if: always()
        run: docker rm -f test-postgres 2>/dev/null || true

  test-race:
    name: Race Detection
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    needs: [lint]
    env:
      TEST_DATABASE_URL: ""
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run race detector
        run: make test-race

  # === DEPENDENCY SECURITY ===
  govulncheck:
    name: Vulnerability Check
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: govulncheck ./...
