name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  # === SECURITY STAGE ===
  secret-detection:
    name: Secret Detection
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          if ! command -v gitleaks &>/dev/null; then
            curl --proto "=https" --tlsv1.2 -sSf -L https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_8.30.0_linux_x64.tar.gz | \
              tar -xz -C /usr/local/bin gitleaks
          fi

      - name: Gitleaks Secret Scan
        run: gitleaks detect --source . --verbose

  sast:
    name: SAST (Semgrep)
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    permissions:
      contents: read
      security-events: write
    if: github.actor != 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v6

      - name: Install Semgrep
        run: |
          if ! command -v semgrep &>/dev/null; then
            pip install semgrep
          fi

      - name: Run Semgrep
        run: semgrep ci
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  gosec:
    name: Gosec Security Check
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v6

      # Install gosec directly using host Go (not Docker action)
      - name: Install gosec
        run: |
          if ! command -v gosec &>/dev/null; then
            go install github.com/securego/gosec/v2/cmd/gosec@latest
          fi
          gosec --version

      - name: Run Gosec Security Scanner
        run: gosec -fmt sarif -out results.sarif ./... || true

      - name: Fix SARIF format for CodeQL
        if: always()
        run: |
          # Remove invalid relationships field that causes validation errors
          jq 'walk(if type == "object" and has("relationships") then del(.relationships) else . end)' results.sarif > results-fixed.sarif
          mv results-fixed.sarif results.sarif

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
        if: always()

  # === QUALITY STAGE ===
  lint:
    name: Lint
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    steps:
      - uses: actions/checkout@v6

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.8
          install-mode: none
        env:
          GOTOOLCHAIN: auto

  fmt-check:
    name: Format Check
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    steps:
      - uses: actions/checkout@v6

      - name: Check formatting
        run: |
          make fmt
          if [ -n "$(git diff --name-only)" ]; then
            echo "Files not formatted with gofumpt:"
            git diff --name-only
            exit 1
          fi

  # === TEST STAGE ===
  test:
    name: Test
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    needs: [lint]
    env:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD || 'test' }}
      POSTGRES_DB: expense_bot_test
      POSTGRES_PORT: 5432
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Start PostgreSQL
        run: |
          docker rm -f test-postgres 2>/dev/null || true
          docker run -d --name test-postgres \
            --network container:$(hostname) \
            -e POSTGRES_USER=${{ env.POSTGRES_USER }} \
            -e POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }} \
            -e POSTGRES_DB=${{ env.POSTGRES_DB }} \
            postgres:18-alpine
          echo "Waiting for PostgreSQL..."
          for i in $(seq 1 30); do
            if docker exec test-postgres pg_isready -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }} > /dev/null 2>&1; then
              echo "PostgreSQL is ready"
              break
            fi
            sleep 1
          done

      - name: Run tests with coverage
        env:
          TEST_DATABASE_URL: postgres://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:${{ env.POSTGRES_PORT }}/${{ env.POSTGRES_DB }}?sslmode=disable
        run: make test-coverage

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          THRESHOLD=50
          echo "Coverage: ${COVERAGE}% (threshold: ${THRESHOLD}%)"
          if [ "$(awk "BEGIN {print ($COVERAGE < $THRESHOLD)}")" = "1" ]; then
            echo "Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%!"
            exit 1
          fi
          echo "Coverage check passed!"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.out
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Stop PostgreSQL
        if: always()
        run: docker rm -f test-postgres 2>/dev/null || true

  test-race:
    name: Race Detection
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    needs: [lint]
    env:
      TEST_DATABASE_URL: ""
    steps:
      - uses: actions/checkout@v6

      - name: Run race detector
        run: make test-race

  # === DEPENDENCY SECURITY ===
  dependency-review:
    name: Dependency Review
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: on-failure

  govulncheck:
    name: Vulnerability Check
    runs-on: [self-hosted, Linux, X64, playground-ubuntu]
    steps:
      - uses: actions/checkout@v6

      - name: Run govulncheck
        run: govulncheck ./...
